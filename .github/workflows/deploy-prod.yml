name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      color:
        description: Deploy target color
        required: true
        default: green
        type: choice
        options:
          - blue
          - green
      image_tag:
        description: Image tag to deploy
        required: true
        default: latest
        type: string

jobs:
  deploy-ethiopia:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy Ethiopia stack color
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_ETHIOPIA_HOST }}
          username: ${{ secrets.PROD_VM_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/cryptopay
            ./scripts/deploy/deploy_color.sh \
              --domain ethiopia \
              --color ${{ inputs.color }} \
              --environment production \
              --image-tag ${{ inputs.image_tag }}

  deploy-offshore:
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Deploy Offshore stack color
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_OFFSHORE_HOST }}
          username: ${{ secrets.PROD_VM_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/cryptopay
            ./scripts/deploy/deploy_color.sh \
              --domain offshore \
              --color ${{ inputs.color }} \
              --environment production \
              --image-tag ${{ inputs.image_tag }}

  smoke-observe-and-switch:
    runs-on: ubuntu-latest
    needs:
      - deploy-ethiopia
      - deploy-offshore
    environment: production
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run smoke checks
        run: |
          ./scripts/smoke/ethiopia_smoke.sh --base-url "${{ secrets.PROD_ETHIOPIA_BASE_URL }}"
          ./scripts/smoke/offshore_smoke.sh --base-url "${{ secrets.PROD_OFFSHORE_BASE_URL }}"

      - name: Guarded 10-minute observation window
        run: |
          ./scripts/smoke/ethiopia_smoke.sh --base-url "${{ secrets.PROD_ETHIOPIA_BASE_URL }}" --observe-seconds 600
          ./scripts/smoke/offshore_smoke.sh --base-url "${{ secrets.PROD_OFFSHORE_BASE_URL }}" --observe-seconds 600

      - name: Switch edge upstream to selected color
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_EDGE_HOST }}
          username: ${{ secrets.PROD_VM_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/cryptopay
            ./scripts/deploy/switch_color.sh --color ${{ inputs.color }} --environment production

  rollback-on-failure:
    runs-on: ubuntu-latest
    if: failure()
    needs:
      - smoke-observe-and-switch
    environment: production
    steps:
      - name: Trigger rollback
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.PROD_EDGE_HOST }}
          username: ${{ secrets.PROD_VM_USER }}
          key: ${{ secrets.PROD_SSH_KEY }}
          script: |
            cd /opt/cryptopay
            ./scripts/deploy/rollback.sh --environment production
