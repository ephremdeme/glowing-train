services:
  postgres:
    image: postgres:16-alpine
    container_name: cryptopay-postgres
    environment:
      POSTGRES_USER: cryptopay
      POSTGRES_PASSWORD: cryptopay
      POSTGRES_DB: cryptopay
    ports:
      - '55432:5432'
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cryptopay -d cryptopay"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7-alpine
    container_name: cryptopay-redis
    command: ["redis-server", "--appendonly", "yes"]
    ports:
      - '6379:6379'
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 20
    volumes:
      - redis_data:/data

  core-api:
    image: node:22-alpine
    container_name: cryptopay-core-api
    working_dir: /workspace
    env_file:
      - .env
    environment:
      APP_REGION: ethiopia
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/core-api dev"]
    volumes:
      - ./:/workspace
    ports:
      - '3001:3001'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
      customer-auth:
        condition: service_started

  customer-auth:
    image: node:22-alpine
    container_name: cryptopay-customer-auth
    working_dir: /workspace
    env_file:
      - .env
    environment:
      APP_REGION: ethiopia
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/customer-auth dev"]
    volumes:
      - ./:/workspace
    ports:
      - '3005:3005'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  offshore-collector:
    image: node:22-alpine
    container_name: cryptopay-offshore-collector
    working_dir: /workspace
    env_file:
      - .env
    environment:
      APP_REGION: offshore
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/offshore-collector dev"]
    volumes:
      - ./:/workspace
    ports:
      - '3002:3002'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  payout-orchestrator:
    image: node:22-alpine
    container_name: cryptopay-payout-orchestrator
    working_dir: /workspace
    env_file:
      - .env
    environment:
      APP_REGION: ethiopia
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/payout-orchestrator dev"]
    volumes:
      - ./:/workspace
    ports:
      - '3003:3003'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  reconciliation-worker:
    image: node:22-alpine
    container_name: cryptopay-reconciliation-worker
    working_dir: /workspace
    env_file:
      - .env
    environment:
      APP_REGION: ethiopia
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/reconciliation-worker dev"]
    volumes:
      - ./:/workspace
    ports:
      - '3004:3004'
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  base-watcher:
    image: golang:1.22-alpine
    container_name: cryptopay-base-watcher
    working_dir: /workspace/workers/base-watcher
    env_file:
      - .env
    command: ["sh", "-lc", "go run ./cmd/main.go"]
    volumes:
      - ./:/workspace
    depends_on:
      postgres:
        condition: service_healthy
      core-api:
        condition: service_started

  solana-watcher:
    image: golang:1.22-alpine
    container_name: cryptopay-solana-watcher
    working_dir: /workspace/workers/solana-watcher
    env_file:
      - .env
    command: ["sh", "-lc", "go run ./cmd/main.go"]
    volumes:
      - ./:/workspace
    depends_on:
      postgres:
        condition: service_healthy
      core-api:
        condition: service_started

  admin-api:
    image: node:22-alpine
    container_name: cryptopay-admin-api
    working_dir: /workspace
    env_file:
      - .env
    environment:
      APP_REGION: ethiopia
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/admin-api dev"]
    volumes:
      - ./:/workspace
    ports:
      - '3010:3010'
    depends_on:
      postgres:
        condition: service_healthy

  web:
    image: node:22-alpine
    container_name: cryptopay-web
    working_dir: /workspace
    env_file:
      - .env
    command: ["sh", "-lc", "corepack pnpm --filter @cryptopay/web dev"]
    volumes:
      - ./:/workspace
    environment:
      HOSTNAME: "0.0.0.0"
      PORT: 3000
      WEB_CORE_API_URL: http://core-api:3001
      WEB_OFFSHORE_COLLECTOR_URL: http://offshore-collector:3002
    ports:
      - '3000:3000'
    depends_on:
      core-api:
        condition: service_started

volumes:
  postgres_data:
  redis_data:
